<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Collect OpenWrt Metrics for Home Assistant - DevOps Notes</title>
<meta name="description" content="This guide details how to set up an MQTT client on your OpenWrt router to send performance metrics to Home Assistant.">


  <meta name="author" content="Stanislav Makar">
  
  <meta property="article:author" content="Stanislav Makar">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="DevOps Notes">
<meta property="og:title" content="Collect OpenWrt Metrics for Home Assistant">
<meta property="og:url" content="https://stamak.github.io/2025/04/12/Mqtt4OpenWrt.html">


  <meta property="og:description" content="This guide details how to set up an MQTT client on your OpenWrt router to send performance metrics to Home Assistant.">







  <meta property="article:published_time" content="2025-04-12T12:00:35+03:00">






<link rel="canonical" href="https://stamak.github.io/2025/04/12/Mqtt4OpenWrt.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "https://stamak.github.io/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="DevOps Notes Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          DevOps Notes
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/posts/">Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/bio-photo.png" alt="Stanislav Makar" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Stanislav Makar</h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Lviv, Ukraine</span>
        </li>
      

      
        
          
            <li><a href="https://github.com/stamak" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/stanislav-makar" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Collect OpenWrt Metrics for Home Assistant">
    <meta itemprop="description" content="This guide details how to set up an MQTT client on your OpenWrt router to send performance metrics to Home Assistant.">
    <meta itemprop="datePublished" content="2025-04-12T12:00:35+03:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Collect OpenWrt Metrics for Home Assistant
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p><img src="/assets/Mqtt4OpenWrt.png" alt="HLA" height="1700px" width="700px" /></p>

<p>Home Assistant is a powerful platform for home automation, and integrating it with OpenWrt-based routers provides valuable network insights. This guide walks you through setting up a lightweight MQTT client on your OpenWrt router to send metrics like CPU usage, memory consumption, and network speed directly to Home Assistant.</p>

<p>We’ll use a small, Go-based MQTT client designed for OpenWrt devices to feed system stats to an MQTT broker, which Home Assistant then uses in real-time.</p>

<h2 id="background">Background</h2>

<p>The initial approach to collecting these metrics involved using SNMP with custom OIDs, with Home Assistant configured to pull the data. However, to shift to a push-based system, a decision was made to develop a custom, Go-based solution. This push method offers advantages over the pull method (like SNMP): reduced overhead on Home Assistant, real-time updates, simplified network configuration, improved scalability, and more reliable data delivery. Go was chosen for its efficiency, small binary size (final binary size is 4.8MB), and ease of cross-compilation, making it ideal for resource-constrained devices like OpenWRT routers. The source code for the MQTT client, named <strong>mqtt4openwrt</strong>, is available on <a href="https://github.com/stamak/mqtt4openwrt/">GitHub</a>.</p>

<h2 id="why-this-matters">Why This Matters</h2>

<p>OpenWrt, an operating system that provides a lot of flexibility for wireless routers, is often critical infrastructure in a smart home. Monitoring their performance provides insights into:</p>
<ul>
  <li>Bandwidth usage</li>
  <li>System resource load</li>
  <li>Troubleshooting degraded performance</li>
  <li>Home network visibility in Home Assistant dashboards</li>
</ul>

<h2 id="project-overview">Project Overview</h2>

<p>This project uses a lightweight Go application, specifically built for OpenWrt (MIPS architecture), to collect system-level metrics, including:</p>
<ul>
  <li><strong>Download and upload speed</strong></li>
  <li><strong>Memory usage</strong></li>
  <li><strong>CPU utilization</strong></li>
</ul>

<p>The client publishes these metrics to an MQTT broker, making them accessible to Home Assistant via MQTT sensors. The setup is minimal and can be extended with additional system metrics or custom scripts.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>Before you begin, ensure you have:</p>
<ul>
  <li>Go installed and your Go environment configured</li>
  <li>Access to your OpenWrt router via SSH</li>
  <li>An MQTT broker (e.g., Mosquitto) reachable by both the router and Home Assistant</li>
  <li>Home Assistant set up with MQTT integration</li>
</ul>

<p>Set up your Go environment:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">GOPATH</span><span class="o">=</span><span class="nv">$HOME</span>/bin/go/
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$GOPATH</span>/bin:<span class="nv">$PATH</span>
</code></pre></div></div>

<h2 id="building-the-mqtt-client">Building the MQTT Client</h2>

<p>To compile the client for OpenWrt (MIPS architecture), run:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>src/mqtt-client
<span class="nv">GOOS</span><span class="o">=</span>linux <span class="nv">GOARCH</span><span class="o">=</span>mipsle <span class="nv">GOMIPS</span><span class="o">=</span>softfloat go build <span class="nt">-ldflags</span><span class="o">=</span><span class="s2">"-w -s"</span> <span class="nt">-o</span> bin/mqtt-clnt
<span class="nb">cd</span> -
</code></pre></div></div>

<p>This command builds a statically linked binary for deployment to your router.</p>

<h2 id="configuration">Configuration</h2>

<p>Before running the client, set the required environment variables:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">MQTT_BROKER</span><span class="o">=</span>127.0.0.1
<span class="nb">export </span><span class="nv">MQTT_PORT</span><span class="o">=</span>1883
<span class="nb">export </span><span class="nv">MQTT_USER</span><span class="o">=</span>mqtt-user
<span class="nb">export </span><span class="nv">MQTT_PASS</span><span class="o">=</span>mqtt-pass
<span class="nb">export </span><span class="nv">MQTT_TOPIC</span><span class="o">=</span><span class="s2">"routers/my-wrt"</span>
</code></pre></div></div>

<p>These values define how and where the client publishes its metrics.</p>

<h2 id="deployment-to-openwrt">Deployment to OpenWrt</h2>

<p>Transfer the binary to your router using SSH:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>src/mqtt-client/bin/mqtt-clnt | <span class="nb">gzip</span> | ssh &lt;USER&gt;@&lt;HOST&gt; <span class="s1">'zcat - &gt; mqtt-clnt'</span>
</code></pre></div></div>

<p>Place the binary in <code class="language-plaintext highlighter-rouge">/root/</code> or another suitable location.</p>

<h2 id="auto-start-on-boot">Auto-Start on Boot</h2>

<p>To ensure the MQTT client starts automatically with your router, add this to <code class="language-plaintext highlighter-rouge">/etc/rc.local</code>:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sleep </span>20s <span class="c"># Allow time for network interfaces to initialize</span>
<span class="nb">source</span> /root/mqtt.conf
<span class="o">(</span>/root/mqtt-clnt<span class="o">)</span> &amp;
logger <span class="s2">"MQTT client started"</span>
</code></pre></div></div>

<p>Make sure your <code class="language-plaintext highlighter-rouge">mqtt.conf</code> file contains the environment variable definitions.</p>

<h2 id="home-assistant-integration">Home Assistant Integration</h2>

<p>To have Home Assistant pick up the metrics, define MQTT sensors in your <code class="language-plaintext highlighter-rouge">configuration.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">mqtt</span><span class="pi">:</span>
  <span class="na">sensor</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">MyWrt</span><span class="nv"> </span><span class="s">Download"</span>
    <span class="na">state_topic</span><span class="pi">:</span> <span class="s2">"</span><span class="s">routers/my-wrt"</span>
    <span class="na">value_template</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s">Mbps</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">MyWrt</span><span class="nv"> </span><span class="s">Upload"</span>
    <span class="na">state_topic</span><span class="pi">:</span> <span class="s2">"</span><span class="s">routers/my-wrt"</span>
    <span class="na">value_template</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s">Mbps</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">MyWrt</span><span class="nv"> </span><span class="s">CPU"</span>
    <span class="na">state_topic</span><span class="pi">:</span> <span class="s2">"</span><span class="s">routers/my-wrt"</span>
    <span class="na">value_template</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s1">'</span><span class="s">%'</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">MyWrt</span><span class="nv"> </span><span class="s">Memory"</span>
    <span class="na">state_topic</span><span class="pi">:</span> <span class="s2">"</span><span class="s">routers/my-wrt"</span>
    <span class="na">value_template</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s1">'</span><span class="s">%'</span>
</code></pre></div></div>

<p>After restarting Home Assistant or reloading YAML configuration, you should see your router’s metrics in your dashboard.</p>

<p><img src="/assets/Mqtt4OpenWrtDownloadGraph.png" alt="Donwload speed dashboard" height="1700px" width="700px" /></p>

<h2 id="final-thoughts">Final Thoughts</h2>

<p>This setup is ideal for smart home enthusiasts who want deeper visibility into their network health. The MQTT client is simple, flexible, and efficient — and can be enhanced further to support additional OpenWrt statistics or other devices in your network.</p>

<p>Whether you’re a tinkerer or a professional building out your smart environment, this solution adds a robust layer of observability to your home setup.</p>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2025-04-12T12:00:35+03:00">April 12, 2025</time></p>


      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Collect+OpenWrt+Metrics+for+Home+Assistant%20https%3A%2F%2Fstamak.github.io%2F2025%2F04%2F12%2FMqtt4OpenWrt.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fstamak.github.io%2F2025%2F04%2F12%2FMqtt4OpenWrt.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fstamak.github.io%2F2025%2F04%2F12%2FMqtt4OpenWrt.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/2024/04/30/k3s.html" class="pagination--pager" title="Taming the Edge with Kubernetes
">Previous</a>
    
    
      <a href="/2025/09/21/CloudRunAndHelm.html" class="pagination--pager" title="Scaling Up: Why Your Cloud Run Deployments Need Helm
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2025 DevOps Notes. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-26K9QK19YL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-26K9QK19YL', { 'anonymize_ip': false});
</script>









  </body>
</html>
